<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconocimiento Facial - Curso RNP 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon-32x32.png">
    <style>
        :root {
            --primary-dark: #4361ee;
            --secondary-dark: #3f37c9;
            --accent-dark: #4cc9f0;
            --success-dark: #4ade80;
            --danger-dark: #f43f5e;
            --dark-dark: #1e293b;
            --light-dark: #f8fafc;
            --gray-dark: #94a3b8;
            
            --primary-light: #3a86ff;
            --secondary-light: #2667cc;
            --accent-light: #00b4d8;
            --success-light: #38b000;
            --danger-light: #d90429;
            --dark-light: #212529;
            --light-light: #ffffff;
            --gray-light: #6c757d;
            
            --face-box: #1E293B;
            --face-label: #1E293B;
            --face-label-unknown: #1E293B;
            
            --bg-dark: #121212;
            --bg-light: #ffffff;
            --text-dark: #ffffff;
            --text-light: #212529;
            --card-bg-dark: #1e1e1e;
            --card-bg-light: #ffffff;
            --border-dark: #333;
            --border-light: #dee2e6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        body.light-mode {
            background-color: var(--bg-light);
            color: var(--text-light);
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }
        
        header {
            text-align: center;
            margin-bottom: 2rem;
            width: 100%;
            position: relative;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .logo-img {
            height: 80px;
            margin: 0 15px;
        }
        
        .logo-fallback {
            display: none;
            width: 80px;
            height: 80px;
            background-color: var(--primary-dark);
            border-radius: 8px;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            margin: 0 15px;
        }
        
        .light-mode .logo-fallback {
            background-color: var(--primary-light);
        }
        
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }
        
        .light-mode h1 {
            color: var(--primary-light);
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: var(--gray-dark);
            font-weight: 400;
        }
        
        .light-mode .subtitle {
            color: var(--gray-light);
        }
        
        .video-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 480px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            background-color: #000;
            border: 3px solid var(--primary-dark);
        }
        
        .light-mode .video-container {
            border-color: var(--primary-light);
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #videoCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #faceCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #faceLabelsContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background-color: var(--primary-dark);
            color: white;
        }
        
        .light-mode .btn-primary {
            background-color: var(--primary-light);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        .light-mode .btn-primary:hover {
            background-color: var(--secondary-light);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-danger {
            background-color: var(--danger-dark);
            color: white;
        }
        
        .light-mode .btn-danger {
            background-color: var(--danger-light);
        }
        
        .btn-dark-mode {
            position: absolute;
            top: 0;
            right: 1rem;
            background-color: var(--dark-dark);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.9rem;
        }
        
        .light-mode .btn-dark-mode {
            background-color: var(--dark-light);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: var(--accent-dark);
            color: white;
            border-radius: 50px;
            font-weight: 500;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: pulse 2s infinite;
        }
        
        .light-mode .status-badge {
            background-color: var(--accent-light);
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 201, 240, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 201, 240, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 201, 240, 0);
            }
        }
        
        .results-section {
            width: 100%;
            max-width: 640px;
            margin-top: 2rem;
        }
        
        .results-card {
            background-color: var(--card-bg-dark);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-dark);
        }
        
        .light-mode .results-card {
            background-color: var(--card-bg-light);
            border-color: var(--border-light);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-dark);
        }
        
        .light-mode .results-header {
            border-bottom-color: var(--border-light);
        }
        
        .results-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .light-mode .results-title {
            color: var(--text-light);
        }
        
        .people-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 100px;
        }
        
        .person-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: rgba(67, 97, 238, 0.1);
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid rgba(67, 97, 238, 0.2);
        }
        
        .light-mode .person-card {
            background-color: rgba(58, 134, 255, 0.1);
            border-color: rgba(58, 134, 255, 0.2);
        }
        
        .person-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .person-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-dark);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: 1rem;
        }
        
        .light-mode .person-icon {
            background-color: var(--primary-light);
        }
        
        .person-icon.denied {
            background-color: var(--danger-dark);
        }
        
        .light-mode .person-icon.denied {
            background-color: var(--danger-light);
        }
        
        .person-info {
            flex: 1;
        }
        
        .person-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }
        
        .light-mode .person-name {
            color: var(--text-light);
        }
        
        .person-name.denied {
            color: var(--danger-dark);
        }
        
        .light-mode .person-name.denied {
            color: var(--danger-light);
        }
        
        .no-results {
            text-align: center;
            padding: 2rem;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 1.1rem;
            font-style: normal;
        }
        
        .light-mode .no-results {
            color: var(--text-light);
        }
        
        .waiting-detection {
            text-align: center;
            padding: 2rem;
            color: var(--gray-dark);
            font-style: italic;
        }
        
        .light-mode .waiting-detection {
            color: var(--gray-light);
        }
        
        .footer {
            margin-top: 3rem;
            padding: 1.5rem 0;
            text-align: center;
            border-top: 1px solid var(--border-dark);
            width: 100%;
        }
        
        .light-mode .footer {
            border-top-color: var(--border-light);
        }
        
        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-dark);
            text-decoration: none;
        }
        
        .light-mode .github-link {
            color: var(--text-light);
        }
        
        .github-link:hover {
            text-decoration: underline;
            color: var(--accent-dark);
        }
        
        .light-mode .github-link:hover {
            color: var(--accent-light);
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .logo-img {
                height: 60px;
            }
            
            .logo-fallback {
                width: 60px;
                height: 60px;
            }
            
            .video-container {
                height: auto;
                aspect-ratio: 4/3;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn, .status-badge {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Estilos para la etiqueta del nombre */
        .face-label {
            position: absolute;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            color: white;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transform: translateY(-100%);
            margin-top: -8px;
            z-index: 10;
            white-space: nowrap;
            background-color: var(--primary-dark);
        }
        
        .light-mode .face-label {
            background-color: var(--primary-light);
        }
        
        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            .video-container {
                height: auto !important;
                aspect-ratio: 4/3 !important;
            }
            
            #video {
                position: relative;
                z-index: 1;
            }
            
            /* Fix for iOS Safari issues */
            body {
                position: fixed;
                width: 100%;
                height: 100%;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button id="darkModeToggle" class="btn-dark-mode" onclick="toggleDarkMode()">
                <span id="darkModeIcon">🌙</span> Modo Claro
            </button>
            
            <div class="logo-container">
                <img class="logo-img" src="logo_rnp.png" alt="Logo RNP" 
                     onerror="this.style.display='none'; document.getElementById('rnp-fallback').style.display='flex';">
                <div id="rnp-fallback" class="logo-fallback">RNP</div>
                
                <img class="logo-img" src="logo_curso.png" alt="Logo Curso" 
                     onerror="this.style.display='none'; document.getElementById('curso-fallback').style.display='flex';">
                <div id="curso-fallback" class="logo-fallback">2025</div>
            </div>
            
            <h1>Reconocimiento Facial</h1>
            <p class="subtitle">Curso RNP 2025 - Detección en tiempo real con DeepFace</p>
        </header>
        
        <div class="video-section">
            <div class="video-container">
                <video id="video" autoplay playsinline muted></video>
                <canvas id="videoCanvas"></canvas>
                <canvas id="faceCanvas"></canvas>
                <div id="faceLabelsContainer"></div>
            </div>
            
            <div class="controls">
                <button id="switchCameraBtn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12c0 1.2-.504 2.267-1.513 3.2-.997.933-2.29 1.4-3.867 1.4-1.6 0-3-.467-4.2-1.4-1.2-.933-1.8-2-1.8-3.2 0-1.2.6-2.267 1.8-3.2 1.2-.933 2.6-1.4 4.2-1.4 1.577 0 2.87.467 3.867 1.4C20.497 9.733 21 10.8 21 12z"/>
                        <path d="M3 9v6"/>
                        <path d="M7 9v6"/>
                    </svg>
                    Cambiar Cámara
                </button>
                <button id="requestPermissionBtn" class="btn btn-primary" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                    Permitir Cámara
                </button>
                <div class="status-badge" id="status">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Cámara activa
                </div>
            </div>
        </div>
        
        <div class="results-section">
            <div class="results-card">
                <div class="results-header">
                    <h2 class="results-title">Personas Detectadas</h2>
                </div>
                <div id="peopleList" class="people-list">
                    <div class="waiting-detection">Esperando detección...</div>
                </div>
            </div>
        </div>
        
        <footer class="footer">
            <a href="https://github.com/Jenn-LG/face-recognition-facenet" class="github-link" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                    <path d="M8 0C3.58 0 0 3.58 0 8a8.013 8.013 0 0 0 5.47 7.59c.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2 .37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13 -.28-.15-.66-.52-.01-.53.61-.01 1.04.57 1.18.8.7 1.18 1.82.85 2.27.65 .07-.51.27-.85.49-1.04-1.78-.2-3.64-.88-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.01.08-2.11 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27 c1.53-1.03 2.2-.82 2.2-.82.44 1.1.16 1.91.08 2.11 .51.56.82 1.28.82 2.15 0 3.07-1.87 3.75-3.65 3.95 .28.24.52.73.52 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                Ver código en GitHub
            </a>
        </footer>
    </div>

    <script>
        // Variables globales
        const video = document.getElementById('video');
        const videoCanvas = document.getElementById('videoCanvas');
        const faceCanvas = document.getElementById('faceCanvas');
        const faceLabelsContainer = document.getElementById('faceLabelsContainer');
        const videoCtx = videoCanvas.getContext('2d');
        const faceCtx = faceCanvas.getContext('2d');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const requestPermissionBtn = document.getElementById('requestPermissionBtn');
        const status = document.getElementById('status');
        const peopleList = document.getElementById('peopleList');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeIcon = document.getElementById('darkModeIcon');
        
        let stream = null;
        let isRunning = false;
        let processingInterval = null;
        let renderingAnimationFrame = null;
        let cameras = [];
        let currentCameraIndex = 0;
        let lastDetectionResults = [];
        let isProcessing = false;
        let trackedFaces = [];
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        // Configurar el tamaño de los canvas
        function setupCanvases() {
            const containerWidth = video.clientWidth;
            const containerHeight = video.clientHeight;
            
            videoCanvas.width = containerWidth;
            videoCanvas.height = containerHeight;
            faceCanvas.width = containerWidth;
            faceCanvas.height = containerHeight;
        }
        
        // Manejar errores del video
        video.addEventListener('error', (e) => {
            console.error('Error en el elemento de video:', e);
            status.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                Error en el video
            `;
            status.style.backgroundColor = 'var(--danger-dark)';
        });
        
        // Alternar modo oscuro/claro
        function toggleDarkMode() {
            document.body.classList.toggle('light-mode');
            
            if (document.body.classList.contains('light-mode')) {
                darkModeIcon.textContent = '🌙';
                darkModeToggle.innerHTML = '<span id="darkModeIcon">🌙</span> Modo Oscuro';
            } else {
                darkModeIcon.textContent = '☀️';
                darkModeToggle.innerHTML = '<span id="darkModeIcon">☀️</span> Modo Claro';
            }
        }
        
        // Inicializar la aplicación
        async function init() {
            switchCameraBtn.addEventListener('click', switchCamera);
            requestPermissionBtn.addEventListener('click', startCamera);
            window.addEventListener('resize', setupCanvases);
            
            // Verificar logos después de 1 segundo
            setTimeout(() => {
                const logos = document.querySelectorAll('.logo-img');
                logos.forEach(logo => {
                    if (!logo.complete || logo.naturalWidth === 0) {
                        logo.style.display = 'none';
                        const fallbackId = logo.alt.toLowerCase().replace('logo ', '').replace(' ', '-') + '-fallback';
                        document.getElementById(fallbackId).style.display = 'flex';
                    }
                });
            }, 1000);
            
            try {
                // Verificar si el navegador soporta getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Tu navegador no soporta acceso a la cámara. Por favor, actualiza a un navegador más reciente.');
                }
                
                // Configurar los canvas
                setupCanvases();
                
                // Enumerar las cámaras disponibles
                await enumerateCameras();
                
                // En iOS, mostrar el botón de solicitar permisos primero
                if (isIOS) {
                    requestPermissionBtn.style.display = 'flex';
                    status.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v4M12 16h.01"/>
                        </svg>
                        Permiso requerido
                    `;
                    status.style.backgroundColor = 'var(--accent-dark)';
                } else {
                    // En otros dispositivos, iniciar la cámara automáticamente
                    await startCamera();
                }
            } catch (error) {
                console.error('Error al inicializar:', error);
                status.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    Error: ${error.message}
                `;
                status.style.backgroundColor = 'var(--danger-dark)';
            }
        }
        
        // Enumerar las cámaras disponibles en el dispositivo
        async function enumerateCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                cameras = devices.filter(device => device.kind === 'videoinput');
                
                console.log('Cámaras disponibles:', cameras.length);
                
                // Deshabilitar el botón de cambio de cámara si solo hay una cámara
                if (cameras.length <= 1) {
                    switchCameraBtn.disabled = true;
                    switchCameraBtn.style.opacity = '0.5';
                    switchCameraBtn.style.cursor = 'not-allowed';
                } else {
                    switchCameraBtn.disabled = false;
                    switchCameraBtn.style.opacity = '1';
                    switchCameraBtn.style.cursor = 'pointer';
                }
            } catch (error) {
                console.error('Error al enumerar cámaras:', error);
                status.textContent = 'Error al acceder a las cámaras';
                status.style.backgroundColor = 'var(--danger-dark)';
            }
        }
        
        // Iniciar la cámara
        async function startCamera() {
            try {
                // Ocultar el botón de solicitar permisos
                requestPermissionBtn.style.display = 'none';
                
                // Si ya hay un stream activo, detenerlo
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Configuración específica para iOS
                let constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                };
                
                // Si hay cámaras disponibles, intentar usar la seleccionada
                if (cameras.length > 0) {
                    try {
                        constraints.video.deviceId = { exact: cameras[currentCameraIndex].deviceId };
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (deviceError) {
                        console.warn("No se pudo acceder a la cámara específica, intentando con cualquier cámara disponible");
                        // Si falla con la cámara específica, intentar con cualquier cámara
                        constraints.video = { 
                            facingMode: "user",
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        };
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                    }
                } else {
                    // Si no hay cámaras enumeradas, intentar con cualquier cámara frontal
                    constraints.video = { 
                        facingMode: "user",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    };
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                }
                
                // Configuración específica para iOS
                if (isIOS) {
                    video.setAttribute('playsinline', 'playsinline');
                    video.setAttribute('muted', 'muted');
                }
                
                video.srcObject = stream;
                
                // Esperar a que el video esté listo
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        resolve();
                    };
                });
                
                // Iniciar el video
                await video.play();
                
                // Actualizar la interfaz
                isRunning = true;
                status.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Cámara activa
                `;
                status.style.backgroundColor = 'var(--accent-dark)';
                
                // Iniciar el renderizado continuo del video
                startVideoRendering();
                
                // Iniciar el reconocimiento facial
                startFaceRecognition();
                
                // Volver a enumerar las cámaras después de obtener permisos
                await enumerateCameras();
            } catch (error) {
                console.error('Error al iniciar la cámara:', error);
                status.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    Error al acceder a la cámara
                `;
                status.style.backgroundColor = 'var(--danger-dark)';
                
                // Mostrar mensaje de error más específico
                peopleList.innerHTML = `
                    <div class="no-results">
                        <p>No se pudo acceder a la cámara. Por favor, asegúrate de:</p>
                        <ul style="text-align: left; margin-top: 10px;">
                            <li>Dar permisos de cámara al navegador</li>
                            <li>Tener una cámara conectada y funcionando</li>
                            <li>No tener la cámara en uso por otra aplicación</li>
                            </ul>
                    </div>
                `;
                
                // Mostrar el botón de solicitar permisos
                requestPermissionBtn.style.display = 'flex';
            }
        }
        
        // Iniciar el renderizado continuo del video
        function startVideoRendering() {
            // Cancelar cualquier animación anterior
            if (renderingAnimationFrame) {
                cancelAnimationFrame(renderingAnimationFrame);
            }
            
            // Función para renderizar el video continuamente
            function renderVideo() {
                if (isRunning && video.readyState === video.HAVE_ENOUGH_DATA) {
                    // Dibujar el video en el canvas
                    videoCtx.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);
                    
                    // Renderizar los cuadros de detección facial con animación suave
                    renderFaceBoxes();
                }
                
                // Continuar el bucle de renderizado
                renderingAnimationFrame = requestAnimationFrame(renderVideo);
            }
            
            // Iniciar el bucle de renderizado
            renderVideo();
        }
        
        // Cambiar de cámara
        async function switchCamera() {
            if (cameras.length <= 1) return;
            
            // Cambiar al siguiente índice de cámara
            currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
            
            // Detener el reconocimiento actual
            if (processingInterval) {
                clearInterval(processingInterval);
                processingInterval = null;
            }
            
            // Limpiar el canvas de caras y las etiquetas
            faceCtx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
            faceLabelsContainer.innerHTML = '';
            
            // Reiniciar el seguimiento de caras
            trackedFaces = [];
            
            // Reiniciar la cámara con la nueva selección
            await startCamera();
        }
        
        // Iniciar el reconocimiento facial
        function startFaceRecognition() {
            // First check if models are loaded
            checkModelsStatus();
        }

        // Add this new function to check model status
        async function checkModelsStatus() {
            try {
                const response = await fetch('/status');
                const data     = await response.json();

                console.log("Status check response:", data);

                if (data.models_loaded) {
                    // Models are loaded, start processing
                    status.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        Modelos cargados (${data.identities} identidades)
                    `;
                    status.style.backgroundColor = 'var(--success-dark)';

                    if (processingInterval) clearInterval(processingInterval);
                    processingInterval = setInterval(processFrame, 500);

                    if (peopleList.querySelector('.waiting-detection')) {
                        peopleList.innerHTML = '<div class="waiting-detection">Esperando detección...</div>';
                    }
                } else {
                    // Models still loading, show status and check again in 3 seconds
                    status.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        Cargando modelos...
                    `;
                    status.style.backgroundColor = 'var(--accent-dark)';

                    peopleList.innerHTML = `
                        <div class="waiting-detection">
                            <p>Cargando modelos de reconocimiento facial. Esto puede tomar hasta 1-2 minutos...</p>
                            <p style="margin-top: 10px; font-size: 0.9em;">
                                Estado: 
                                ${data.embedder_loaded  ? '✅' : '⏳'} FaceNet 
                                ${data.detector_loaded  ? '✅' : '⏳'} Detector 
                                ${data.identities > 0   ? '✅' : '⏳'} Embeddings
                            </p>
                        </div>`;

                    setTimeout(checkModelsStatus, 3000);
                }
            } catch (error) {
                console.error('Error checking model status:', error);
                status.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    Error de conexión
                `;
                status.style.backgroundColor = 'var(--danger-dark)';
                setTimeout(checkModelsStatus, 5000);
            }
        }
        
        // Procesar un frame del video
        async function processFrame() {
            if (!isRunning || !stream || !stream.active || isProcessing) return;
            
            try {
                isProcessing = true;
                
                // Verificar si el video está listo
                if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                    isProcessing = false;
                    return;
                }
                
                // Obtener la imagen del canvas de video
                const imageData = videoCanvas.toDataURL('image/jpeg', 0.8);
                
                // Enviar la imagen al servidor para reconocimiento
                const response = await fetch('/reconocer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: imageData })
                });
                
                if (!response.ok) {
                    // If models aren't loaded (503), handle gracefully
                    if (response.status === 503) {
                        console.log('Modelos aún cargando, esperando...');
                        // No need to throw error, just return
                        isProcessing = false;
                        return;
                    }
                    throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Actualizar los resultados de detección con seguimiento
                    updateTrackedFaces(data.resultados);
                    
                    // Mostrar los resultados
                    displayResults(data.resultados);
                    
                    // Actualizar las etiquetas de nombres
                    updateFaceLabels();
                } else {
                    console.error('Error en el reconocimiento:', data.error);
                }
            } catch (error) {
                console.error('Error al procesar el frame:', error);
                
                // Si hay un error de conexión, mostrar mensaje
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    peopleList.innerHTML = '<div class="no-results">Error de conexión con el servidor. Verifica que el servidor Flask esté ejecutándose.</div>';
                }
            } finally {
                isProcessing = false;
            }
        }
        
        // Actualizar las caras rastreadas con los nuevos resultados
        function updateTrackedFaces(newResults) {
            if (trackedFaces.length === 0) {
                // Primera detección, inicializar el seguimiento
                trackedFaces = newResults.map(result => ({
                    ...result,
                    targetX: result.bbox[0],
                    targetY: result.bbox[1],
                    targetW: result.bbox[2],
                    targetH: result.bbox[3],
                    currentX: result.bbox[0],
                    currentY: result.bbox[1],
                    currentW: result.bbox[2],
                    currentH: result.bbox[3],
                    id: Math.random().toString(36).substr(2, 9)
                }));
            } else {
                // Actualizar las caras existentes y añadir nuevas
                const updatedFaces = [];
                
                // Para cada nueva detección
                newResults.forEach(newFace => {
                    const [x, y, w, h] = newFace.bbox;
                    
                    // Buscar la cara más cercana en las caras rastreadas
                    let closestFace = null;
                    let minDistance = Infinity;
                    
                    trackedFaces.forEach(trackedFace => {
                        const centerX1 = x + w/2;
                        const centerY1 = y + h/2;
                        const centerX2 = trackedFace.targetX + trackedFace.targetW/2;
                        const centerY2 = trackedFace.targetY + trackedFace.targetH/2;
                        
                        const distance = Math.sqrt(
                            Math.pow(centerX1 - centerX2, 2) + 
                            Math.pow(centerY1 - centerY2, 2)
                        );
                        
                        if (distance < minDistance && distance < 100) { // Umbral de distancia
                            minDistance = distance;
                            closestFace = trackedFace;
                        }
                    });
                    
                    if (closestFace) {
                        // Actualizar la cara existente
                        closestFace.bbox = newFace.bbox;
                        closestFace.nombre = newFace.nombre;
                        closestFace.distancia = newFace.distancia;
                        closestFace.targetX = x;
                        closestFace.targetY = y;
                        closestFace.targetW = w;
                        closestFace.targetH = h;
                        
                        updatedFaces.push(closestFace);
                    } else {
                        // Añadir una nueva cara
                        updatedFaces.push({
                            ...newFace,
                            targetX: x,
                            targetY: y,
                            targetW: w,
                            targetH: h,
                            currentX: x,
                            currentY: y,
                            currentW: w,
                            currentH: h,
                            id: Math.random().toString(36).substr(2, 9)
                        });
                    }
                });
                
                // Actualizar la lista de caras rastreadas
                trackedFaces = updatedFaces;
            }
            
            // Guardar los resultados para uso posterior
            lastDetectionResults = newResults;
        }
        
        // Renderizar los cuadros de detección facial con animación suave
        function renderFaceBoxes() {
            // Limpiar solo el canvas de caras, no el de video
            faceCtx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
            
            // Si no hay caras rastreadas, salir
            if (trackedFaces.length === 0) return;
            
            // Renderizar cada cara con animación suave
            trackedFaces.forEach(face => {
                // Interpolar suavemente hacia la posición objetivo
                face.currentX = lerp(face.currentX, face.targetX, 0.3);
                face.currentY = lerp(face.currentY, face.targetY, 0.3);
                face.currentW = lerp(face.currentW, face.targetW, 0.3);
                face.currentH = lerp(face.currentH, face.targetH, 0.3);
                
                // Dibujar el rectángulo con estilo mejorado - mismo color para todas las caras
                faceCtx.strokeStyle = 'var(--face-box)';
                faceCtx.lineWidth = 3;
                faceCtx.beginPath();
                faceCtx.roundRect(
                    face.currentX, 
                    face.currentY, 
                    face.currentW, 
                    face.currentH, 
                    8
                );
                faceCtx.stroke();
            });
        }
        
        // Actualizar las etiquetas de nombres
        function updateFaceLabels() {
            // Limpiar las etiquetas existentes
            faceLabelsContainer.innerHTML = '';
            
            // Crear una etiqueta para cada cara
            trackedFaces.forEach(face => {
                // Crear un elemento para la etiqueta
                const label = document.createElement('div');
                label.className = 'face-label';
                label.textContent = face.nombre;
                
                // Posicionar la etiqueta sobre la cara
                label.style.position = 'absolute';
                label.style.left = `${face.currentX}px`;
                label.style.top = `${face.currentY - 30}px`;
                
                // Añadir la etiqueta al contenedor
                faceLabelsContainer.appendChild(label);
            });
        }
        
        // Función de interpolación lineal para animación suave
        function lerp(start, end, factor) {
            return start + (end - start) * factor;
        }
        
        
        function displayResults(resultados) {
            peopleList.innerHTML = '';

            // 1) Sin detección - no mostrar nada
            if (resultados.length === 0) {
                peopleList.innerHTML = ''; // Dejamos vacío el contenedor
                return;
            }

            // 2) Nombre "unknown"
            const nombre = resultados[0].nombre.toLowerCase();
            if (nombre === 'unknown' || nombre === 'desconocido') {
                // Usar el mismo estilo que el mensaje de bienvenida
                const denyCard = document.createElement('div');
                denyCard.className = 'person-card';
                denyCard.innerHTML = `
                    <div class="person-icon denied">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                    </div>
                    <div class="person-info">
                        <div class="person-name denied">Acceso Denegado</div>
                    </div>`;
                peopleList.appendChild(denyCard);
                return;
            }

            // 3) Bienvenida
            const welcomeCard = document.createElement('div');
            welcomeCard.className = 'person-card';
            welcomeCard.innerHTML = `
                <div class="person-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <div class="person-info">
                    <div class="person-name">Bienvenido, ${resultados[0].nombre}</div>
                </div>`;
            peopleList.appendChild(welcomeCard);

            // 4) Lista de reconocidos (si quieres evitar repetir al primero):
            resultados.slice(1).forEach(resultado => {
                const personDiv = document.createElement('div');
                personDiv.className = 'person-card';
                personDiv.innerHTML = `
                <div class="person-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" 
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <div class="person-info">
                    <div class="person-name">${resultado.nombre}</div>
                </div>`;
                peopleList.appendChild(personDiv);
            });
        }

        // Inicializar la aplicación cuando se cargue la página
        window.addEventListener('load', init);
    </script>
</body>
</html>